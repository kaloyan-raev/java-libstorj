language: java

os:
- linux
- osx

dist: trusty
osx_image: xcode9.2

sudo: true

env:
  global:
  - LD_LIBRARY_PATH=/usr/local/lib

before_install:
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    sudo apt-get install build-essential libtool autotools-dev automake libmicrohttpd-dev bsdmainutils;
    sudo apt-get install libcurl4-gnutls-dev libjson-c-dev;
    curl -sSL https://ftp.gnu.org/gnu/nettle/nettle-3.2.tar.gz | tar -zxv;
    cd nettle-3.2 && autoconf && ./configure && make && sudo make install && cd ..;
    curl -sSL https://github.com/libuv/libuv/archive/v1.8.0.tar.gz | tar -zxv;
    cd libuv-1.8.0 && ./autogen.sh && ./configure && make && sudo make install && cd ..;
  fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
    brew install -v libtool automake libmicrohttpd pkgconfig;
    brew install -v curl nettle json-c libuv;
  fi

install:
- git clone https://github.com/Storj/libstorj.git
- cd libstorj && ./autogen.sh && CFLAGS="-std=gnu11" ./configure && make && sudo make install && cd ..

script:
- if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
    jdk_switcher use oraclejdk8;
  fi
- if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then
    export JAVA_HOME=$(/usr/libexec/java_home);
  fi
- ./gradlew build --info

before_cache:
- rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - "$HOME/.gradle/caches/"
  - "$HOME/.gradle/wrapper/"
  - "$HOME/Library/Caches/Homebrew"

before_deploy:
- cd build/libs/jni/shared/
- cp /usr/local/lib/libstorj.2.dylib .
- cp /usr/lib/libcurl.4.dylib .
- cp /usr/local/opt/nettle/lib/libnettle.6.dylib .
- cp /usr/local/opt/json-c/lib/libjson-c.2.dylib .
- cp /usr/local/opt/libuv/lib/libuv.1.dylib .
- chmod 666 *.dylib
- install_name_tool -id libstorj.2.dylib libstorj.2.dylib
- install_name_tool -id libcurl.4.dylib libcurl.4.dylib
- install_name_tool -id libnettle.6.dylib libnettle.6.dylib
- install_name_tool -id libjson-c.2.dylib libjson-c.2.dylib
- install_name_tool -id libuv.1.dylib libuv.1.dylib
- install_name_tool -change /usr/local/lib/libstorj.2.dylib libstorj.2.dylib libstorj-java.dylib
- install_name_tool -change /usr/lib/libcurl.4.dylib libcurl.4.dylib libstorj-java.dylib
- install_name_tool -change /usr/local/opt/json-c/lib/libjson-c.2.dylib libjson-c.2.dylib libstorj-java.dylib
- install_name_tool -change /usr/local/opt/nettle/lib/libnettle.6.dylib libnettle.6.dylib libstorj-java.dylib
- install_name_tool -change /usr/local/opt/libuv/lib/libuv.1.dylib libuv.1.dylib libstorj-java.dylib
- install_name_tool -change /usr/lib/libcurl.4.dylib libcurl.4.dylib libstorj.2.dylib
- install_name_tool -change /usr/local/opt/json-c/lib/libjson-c.2.dylib libjson-c.2.dylib libstorj.2.dylib
- install_name_tool -change /usr/local/opt/nettle/lib/libnettle.6.dylib libnettle.6.dylib libstorj.2.dylib
- install_name_tool -change /usr/local/opt/libuv/lib/libuv.1.dylib libuv.1.dylib libstorj.2.dylib
- tar -zcf java-libstorj-$TRAVIS_TAG-macos-dylibs.tar.gz *.dylib
- cd ../../../../

deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: sUl29Ge+qL9iP0mfX0WFqetEgmKgpnCyGSbkDEJauwDILS/SNrz10S3GTMquwX4IlozOw8G+ri6hQ/hQ3JqAgcms389EU8XqVoEeV/rKRs0RbO3NlBk3OJpuspb4WPV3u2PDz6KFwQHt4hKTveOx+kTfPapt6d7TQ22L7juh4xNYisLvBvDz6tKQURIO9WlG1hY6QOhdF2dVR7LhMg9MLo/EjmS8ZXuzJ3CRAmU6wp7DEF3c1Zlm9PwcPpgm/vD2hzFEoh6AYlQBxoEJf8/aa6CoLrCdQdv+inrvHkyqNVADa1RBrTk5EqCAX9shAiiCEZoTky44llM8hlJsgVV+Wx46ukSo+AxoFR/LNvuFilkMgM3bNL91XEyiyu3JBbutHWJfrCEkArr4/LMGhAgCyny4R6sieijJublYLbmmINOjid4J3x6TbcwK3vQrf0qScPlPD4iVNIs/frMewqHpXh+rKIr2tz8oTmY58PtGAhmniiWLGPTixzAjvBe5F4Ash+zxcvLuXZAtgzbYsJR3Pg4lhVsa2Lm9BjG3WNbvXsm5M8MKkVNhEX73zpGG202PG1iUM3HAYywsDOO3eoYEkOlVmZbarSCHwDxvIhrhaolgJ007BrDe2UdgCRH3Tmw6Vxe1lXINOK6Ts08p84qJOLOtF2cLj2mWJGsdBiEiGo0=
  file:
  - build/libs/libstorj-java-$TRAVIS_TAG.jar
  - build/libs/jni/shared/java-libstorj-$TRAVIS_TAG-macos-dylibs.tar.gz
  on:
    repo: kaloyan-raev/java-libstorj
    tags: true
